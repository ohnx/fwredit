<!DOCTYPE html>
<html lang="en">
<head>
<title>Fun With Robots &middot; Editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style type="text/css" media="screen">
    body {
      overflow: hidden;
    }
    .sideLeft {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 50%;
    }
    .sideRight {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 50%;
    }
    iframe {
      width: 100%;
      height: 100%;
    }
    #buttonbar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4em;
        padding: 0.5em;
        box-sizing: border-box;
        background: teal;
        color: white !important;
    }
    #editor {
        position: absolute;
        top: 2em;
        left: 0;
        right: 0;
        bottom: 15em;
    }
    #console {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 15em;
        padding: 0 0.5em;
        box-sizing: border-box;
        background: black;
        color: white !important;
        font-family: 'Consolas', monospace;
        overflow-y: scroll;
    }
    .msg-err {
        color: red;
    }
    #console-body {
        white-space: pre-wrap;
    }
    #viewport {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: pink;
    }
    #speedometer {
      color: #ffffff;
      background-color: #990000;
      position: absolute;
      bottom: 0px;
      padding: 5px;
    }
    #info {
      position: absolute;
      top: 0px; width: 100%;
      padding: 5px;
    }
    #buttonbar a {
      cursor: pointer;
    }
</style>
</head>
<body>

<div class="sideLeft">
    <div id="buttonbar">
        <a href="#">Open Local File</a>&nbsp; &middot; &nbsp;
        Changes saved automatically! &nbsp; &middot; &nbsp;
        <a href="#">Download</a> &nbsp; &middot; &nbsp;
        <a href="#">Check for errors</a> &nbsp; &middot; &nbsp;
        <a onclick="compileCode(reloadSimulator)">Compile and Run</a> &nbsp; &middot; &nbsp;
        <a id="simPauser" onclick="pauseSimulator()">Stop Simulator</a>
    </div>
<div id="editor">#include &lt;Romi32U4.h&gt;

// Run once, when the sketch starts
void setup() {
  delay(10);
}

// Run over and over again
void loop() {
  delay(100);
}
</div>
  <div id="console">
    <pre id="console-body"></pre>
  </div>
</div>

<div class="sideRight">
  <iframe id="simulator" srcdoc="<html><body><h1>Page loading...</h1></body></html>"></iframe>
</div>

<!-- editor side -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js" type="text/javascript" charset="utf-8"></script>
<script>
let disableSimulator = false;
let editor = null;

/* global ace, fetch, localStorage */
(function() {
    ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/');
    ace.config.set('fontSize', '16px');
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/dawn");
    editor.session.setMode("ace/mode/c_cpp");

    const urlParams = new URLSearchParams(window.location.search);
    checkSimulatorDisabled(urlParams.has('disableSimulator'));
})();

function checkSimulatorDisabled(overrideDisableSim) {
  if (overrideDisableSim != undefined) disableSimulator = overrideDisableSim;
  if (!disableSimulator) {
    document.getElementById('simulator').removeAttribute('srcdoc');
    document.getElementById('simulator').src = 'simulator.html';
  } else {
    document.getElementById('simulator').srcdoc = '<html><body><h1>Simulator disabled.</h1></body></html>';
  }
}

function reloadSimulator() {
  document.getElementById('simulator').contentWindow.location.reload();
}

function pauseSimulator() {
  let pauser = document.getElementById('simPauser');
  if (pauser.innerHTML.indexOf('Stop') >= 0) {
    // pause simulation
    checkSimulatorDisabled(!disableSimulator);
    pauser.innerHTML = 'Start Simulation';
  } else {
    // resume simulation
    checkSimulatorDisabled(!disableSimulator);
    pauser.innerHTML = 'Stop Simulation';
  }
}

function addMessageToConsole(msg, iserr = false) {
  console.log(msg);
  let consoleBody = document.getElementById('console-body');
  if (!iserr) {
    consoleBody.textContent += msg;
  } else {
    // want to display errors in red
    let mySpan = document.createElement('span');
    let spanContents = document.createTextNode(msg);
    mySpan.appendChild(spanContents);
    mySpan.classList.add('msg-err');
    consoleBody.appendChild(mySpan);
  }
  setTimeout(function() {
    consoleBody.scrollTop = consoleBody.scrollHeight;
  }, 100);
}

function compileCode(cb) {
  fetch('/compile', {
    method: 'POST',
    headers: {
      'Content-Type': 'text/plain',
    },
    body: editor.getValue()
  })
  .then(response => response.json())
  .then(data => {
    if ('stdout' in data && data.stdout.length > 0) {
      let lines = data.stdout.split('\\n');
      for (var i = 0; i < lines.length; i++) {
        addMessageToConsole(lines[i]);
      }
    }
    if ('stderr' in data && data.stderr.length > 0) {
      let lines = data.stderr.split('\\n');
      for (i = 0; i < lines.length; i++) {
        addMessageToConsole(lines[i], true);
      }
    }
    if ('code' in data && data.code == 0) {
      localStorage.setItem('FILE_LOC', data.path);
      // successful result
      if (cb) cb();
    }
  })
  .catch((error) => {
    console.error('Error:', error);
  });
}

/* called by the child iframe */
function simulatorReadyCallback() {
  document.getElementById('simulator').contentWindow.Simulator.registerSerialReceiver(addMessageToConsole);
  startSimulation();
}

function startSimulation() {
  let lastKnownFile = localStorage.getItem('FILE_LOC');
  if (lastKnownFile) {
    document.getElementById('simulator').contentWindow.Simulator.run(lastKnownFile);
  }
}
</script>
</body>
</html>
